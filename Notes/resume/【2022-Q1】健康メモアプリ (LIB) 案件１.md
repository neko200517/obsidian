## 基本情報

### 参画期間 

2022年 / 半年以内

### プロジェクトカテゴリ

Webサービス / 受託開発

### 担当工程

- 要件定義
- 設計
- コーディング
- テスト

### 経験した職種・役割

- バックエンド
- フロントエンド
- インフラ

### 使用技術

- AWS
- Teraform
- PostgreSQL
- Webpack
- JQuery
- Bootstrap 
- Git
- Node.js など

### 開発メンバー

1名

## プロジェクトの詳細

### 概要

医療向けの健康管理アプリの開発プロジェクトの開発

### 背景

医療機関に記録として残っていない比較的軽微な病状や無自覚な成人病予備軍が多くいることが周知されているが、それが統計上数値として出てこないことが問題視されている。
そういった隠れ成人病予備軍のデータを取得するために本プロジェクトが立案された。

### 目的

利用者の体重、血圧、歩数を定量的なデータに落とし込み、医療従事者が成人病予備軍を事前に見つけ出すといったことがゴールになっているが、現在は個人情報の取扱は行っていないのでデータ収集が主となっている。本アプリの公開は弊社セミナー参加者のみに配布されている。

### スクラム開発

- アジャイル手法であるスクラム開発を取り入れた。
- 協力会社のプロパーがスクラムマスターとなり、自身は技術的な支援をしながら開発をすすめるというのが主な役割だった。
- 週１のスプリントでユーザに進捗内容を共有し、認識合わせと次回実装予定の打ち合わせを行った。
- デイリースクラムを行い、次回スプリントの進め方や課題の打ち合わせを行った。
- 機能別に各タスクを分解してタスクごとにポイントを割り振り、最大１３ポイントを超えないようにして稼働のコントロールを行った。
- 機能要件をすべて満たして全6回のスプリントで開発フェーズは完了した。
- 後期は非機能要件面でのセキュリティなどに関する支援を行った。課題解決のためのベストプラクティスの調査を行い、パブリッククラウドで実現可能な範囲のみ対応する折衝を行った。

### 使用技術

- インフラ
  - VPC, IAM, EC2, Rout53, ACM, Cognito, Cloud Front, S3 など
- バックエンド
  - API Gateway, Lambda(Node.js)
- フロントエンド
  - JQuery, Bootstrap, Webpack
- DB
  - RDS(PostgreSQL)
- セキュリティ・監視
  - WAF, Cloud Watch, Synthetics Canary
- その他
  - Terraform, Serverless Framework, Git, Webpack

### 工夫した点

- AWS関連のネット記事やブラックベルトによるベストプラクティスの模索と検証を行うところから0→1で始めた。
- アジャイル開発ということで、短い納期のためにフロントの技術はモダンではないが使い慣れているJQuery+Bootstrapでモックを組んだ。
- Code CommitとGitを連携してフロントエンドをデプロイし、Serverless Frameworkを用いてバックエンドを組み、Amplifyでユーザに試供環境を整えることで開発とユーザの認識合わせを早々に行うことを優先して取り組んだ。
- アプリ開発だけでなく各種セキュリティ対策、監視体制を引き、異常があればアラートをグループメールに連携すると言った構築を行った。
- 初期は突貫工事的に作っていたので、後にWebpackなどを導入してパッケージを管理し、リファクタリングを行った。
- 初期はマネジメントコンソールで手作業だったものをTerraformでコード化し、開発環境と本番環境の2面を即日展開すると言った作業の効率化を行った。
- 各種サービスの見積もりも行い、リソースの増加率やユーザ数の見込みから無料利用枠のEC2とRDSを利用することで月50＄いかない程度のコストに抑えた。

### Terrafomeで行った作業

はじめにTerraformで構築せず、下記要件に従った環境を手作業で行った後、可能な部分のみTerraformでコード化した。開発環境向けのdev.tfvarファイルと本番環境向けのprod.tfvarファイルを用意し、仕様変更に柔軟な作りにした。

- VPC・・・環境ごとに大まかなVPCを構築。例として10.0.0.0/16のセグメントと20.0.0.0/16のセグメントを作成し、東京リージョンのap-northeast-1a, 1c, 1dにサブネットの割当。Lambda、踏み台EC2サーバ疎通用にセキュリティグループの設定。LambdaとSecrets Managerにエンドポイントで疎通設定。
- IAM・・・サービス間の許可設定をロールとポリシーで行う。Lambdaの実行やCloud Watch LogsからS3への許可など。分量が多いため割愛。
- EC2・・・RDSを開発機と接続するための踏み台サーバ。Tera Termと開発PCのSSH接続、RDSの5432ポートのみ疎通可能なようにセキュリティグループを設定。
- RDS・・・試験運用なので無料利用枠のt2.microで運用。マルチAZで冗長化はしない。RDS Proxyと共に使用してLambdaの同時接続によるサーバダウンを回避。自動バックアップ期間を35日に設定し、障害時にスナップショットからリストアする。後述Lambdaと開発PC以外からアクセスできないようにセキュリティグループを設定している。
- Cloud Front・・・フロントエンドのエンドポイントとして使用。S3とOAI接続で利用。セキュリティヘッダポリシーを作成しクリックジャッキングやXSS対策を行う。WAFを適応し、日本以外のIPをブロック、OWASP Top10など一般的なセキュリティ対策を施している。ACMと連携しTLS1.2以上のみで通信可能にしている。Route 53と連携し、独自ドメインで公開している。
- Cognito・・・ユーザ認証に使用。要件ではユーザ作成は管理者のみが行うようになっていたのでサインアップ機能は使用していない。更新トークン期間は1日に設定し、1日ごとにログインを促すようにしている。アドバンスドセキュリティ機能は使用していない。
- API Gateway・・・Web APIのエンドポイント。前述のCognitoの認証オーソライザー機能を使用し、セッション中のユーザー以外は外側からAPIを叩けないようにした。具体的にはAuthorizationヘッダにjwtトークンを持っていないと通過出来ないようにしている。WAFを適用し、SQLインジェクションなどを未然に防いでいる。こちらは後述Lambdaと連携しているのでServerless Frameworkでデプロイしている。ACMと連携しTLS1.2以上のみで通信可能にしている。Route 53と連携し、独自ドメインで公開している。
- Lambda・・・Terraformでデプロイするには適していないのでServerless Frameworkを利用している。IAMロールとセキュリティグループ、サブネットはTerraformで構築したものを利用している。レスポンスヘッダにCORS対応のコードを仕込んでいる。
- WAF・・・AWSの無料マネージドルールの適応（Core Rule Set, Known Bad Inputsなど）、Geoルールで日本以外の通信をブロック、プロキシを通して社外のIPブロックなど（こちらは次期フェーズの課題）。
- Cloud Watch・・・監視設定は手入力で行っている。
- SNS・・・上記Cloud Watchで設定したアラートを受けグループメールに通知を行うように設定。
- Route53・・・独自ドメインの登録。.com = 年間1,200＄。下記ACMのドメイン認証に利用。
- ACM・・・SSL/TLS証明書として使用。Cloud FrontとAPI Gatewayと連携してTLS1.2以上の通信を行うようにしている。

### 案件で使用したtfファイル

https://github.com/neko200517/terraform_test
※公開できない設定ファイルは全て削除している

### 案件で使用したServerless一式

- Node.js
https://github.com/neko200517/serverless_test
※公開できない設定ファイルは全て削除している

### 案件で使用したwebpack.config

- devとprodで2つの構成を使い分けるようにしている。
- html-webpack-pluginを使用してhtmlを自動生成し、マルチページ構成にしている。
- 競合しているjQueryと共存できるようにカスタマイズを行っている。
- Babelでトランスパイルして古いブラウザに対応するようにしている。
- Autoprefixerを有効化してCSSにベンダープレフィックスを付与。
- CleanWebpackPluginでdistの中身をクリーンアップしつつ、特定のファイルは削除しないようにカスタマイズしている。
- distフォルダ内のgitをpushしてCodeCommitにデプロイしている。

https://github.com/neko200517/jquery_boilerplate
※公開できない設定ファイルは全て削除している

### 成果

典型的なウォータフォール型Slerの協力会社にAWS + アジャイル開発の実績をもたらした。
本番運用は6月リリースなのでユーザの意見はまだわからないが、こういったミニマムな案件から大きな案件獲得の足がかりになってくれればと考えている。