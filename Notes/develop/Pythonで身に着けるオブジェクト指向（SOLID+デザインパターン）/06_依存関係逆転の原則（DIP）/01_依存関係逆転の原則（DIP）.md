上位のモジュールは、下位のモジュールに依存してはならない。どちらのモジュールも抽象に依存すべきである。抽象は実装の詳細に依存してはならない。実装の詳細が抽象に依存すべきである。

## 上位のモジュール 

⇒　人間に近い処理を担当（例：ビジネスのルール、アプリケーションのユースケースなど）
⇒　アプリケーションの目的（なぜ存在するのか？）を体現する

## 下位のモジュール 

⇒　コンピュータに近い処理を担当（例：データベースのアクセス、アルゴリズム、外部との通信など）
⇒　アプリケーションの目的と手段（どう実現するのか？）を体現する

## DIPに違反したサンプル

次のコードでは上位モジュールである注文処理（process_order）が
- ユーザーの有効性チェック
- 在庫チェック 
- 支払い処理 
- 在庫更新処理 
といった、データベースアクセスや外部サービスの利用などを伴う下位モジュールから構成されている。

下記のコードは上位モジュールが下位モジュールに依存しているためDIPに違反している。

```python
# eコマースの注文処理


#### 下位モジュール
def validate_user(user_name: str) -> str:
    # ユーザーの有効性をチェック
    pass


def check_stock(product_name: str) -> bool:
    # 在庫をチェック
    pass


def make_payment(user_name: str, product_name: str) -> bool:
    # 支払いを処理
    pass


def update_stock(product_name: str) -> None:
    # 在庫を更新
    pass


##### 上位モジュール
def process_order(user_name: str, product_name: str) -> str:
    if not validate_user(user_name):
        return "無効なユーザーです"
    if not check_stock(product_name):
        return "在庫切れです"
    if not make_payment(user_name, product_name):
        return "購入額が足りません"

    update_stock(product_name)
    return "注文処理が完了しました"
```

## 上位から下位のモジュールへの依存の問題

上位モジュールが下位モジュールに依存していると
⇒　下位モジュールの変更に、上位モジュールが影響を受ける構造になっている

現実に置き換えると違和感がある
⇒　手段の変更によって目的を変えるようなもの
　⇒　例：決済の仕方で注文できるものが変わるといったおかしな構造になる

構造化プログラミングの時代から依存の方向性を「逆転」させて
常に手段（下位モジュール）が目的（上位モジュール）に依存するべき
⇒　これを達成するための原則がDIP 

Bad：上位モジュールが下位モジュールに依存する
Good：下位モジュールが上位モジュールに依存する